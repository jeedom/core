name: PHPStan

on:
  push:
    branches: [ alpha ]
  pull_request:
    branches: [ alpha ]

jobs:
  phpstan:
    runs-on: ubuntu-latest
    # define every php version to test
    strategy:
      # do not stop at first fail
      fail-fast: false
      matrix:
        php: [7.4, 8.2]

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP ${{ matrix.php }} for dependencies
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}

      - name: Install Dependencies
        run: composer update --ignore-platform-reqs

      - name: Restore PHPStan cache
        id: cache-phpstan
        uses: actions/cache/restore@v3
        with:
          path: phpstan.phar
          key: phpstan-1

      - name: Run PHPStan
        run: vendor/bin/phpstan analyse --configuration phpstan.neon

  update-baseline:
    needs: phpstan
    if: github.event_name == 'push' && github.ref == 'refs/heads/alpha'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Delete existing branch if exists
        run: |
          git ls-remote --exit-code --heads origin update-phpstan-baseline && git push origin --delete update-phpstan-baseline

      - name: Setup PHP 7.4 for dependencies
        uses: shivammathur/setup-php@v2
        with:
          php-version: 7.4

      - name: Install Dependencies
        run: composer update --ignore-platform-reqs

      - name: Generate new baseline
        id: generate-baseline
        run: |
          cp phpstan-baseline.neon phpstan-baseline.neon.old
          vendor/bin/phpstan analyse --configuration phpstan.neon --generate-baseline
          if ! diff -q phpstan-baseline.neon phpstan-baseline.neon.old > /dev/null; then
            echo "baseline_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.generate-baseline.outputs.baseline_changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: Update PHPStan baseline
          title: '[CI] Update PHPStan baseline'
          body: |
            Mise à jour automatique du baseline PHPStan suite à la correction d'erreurs.
            
            Cette PR a été générée automatiquement par le workflow CI/CD.
          branch: update-phpstan-baseline
          base: alpha
          delete-branch: true
          add-paths: |
            phpstan-baseline.neon
          reviewers: |
            zoic21
            Hotfirenet
            tmartinez69009
            Salvialf
            Sekiro-kost
            reineabs
